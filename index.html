<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercise Trainer Assistant</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1024,#0a0f1e 40%,#0b1324);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1000px;margin:32px auto;padding:16px}
    .title{font-size:28px;font-weight:800;letter-spacing:.4px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 24px}
    .card{background:linear-gradient(180deg,#0d1427,#0b1020);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    textarea{width:100%;min-height:240px;background:#0b1222;color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:14px 16px;line-height:1.45;font-size:14px;resize:vertical}
    input,select{background:#0b1222;color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#06b6d4,#0ea5e9);color:#001018}
    .btn-secondary{background:#0b1222;border:1px solid #1f2937;color:var(--text)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .stack{display:grid;gap:14px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b1222;border:1px solid #1f2937}
    .hr{height:1px;background:#1f2937;margin:12px 0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;text-align:left}
    .table th{color:#a7b0c0;font-weight:700}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .box{flex:1 1 200px;border:1px solid #1f2937;border-radius:14px;padding:12px 14px;background:#0b1222}
    .kpi .box h4{margin:0 0 6px;font-size:12px;color:#b6c0cf;text-transform:uppercase;letter-spacing:.08em}
    .kpi .box div{font-size:22px;font-weight:800}
    .note{font-size:13px;color:#b3becf}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    .footer{margin-top:14px;font-size:12px;color:#8aa0b6}
    .hidden{display:none}
    code{background:#0b1222;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    @keyframes shake {10%, 90% {transform: translateX(-1px);} 20%, 80% {transform: translateX(2px);} 30%, 50%, 70% {transform: translateX(-4px);} 40%, 60% {transform: translateX(4px);} }
    .shake {animation: shake .4s linear 1}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">üèãÔ∏è‚Äç‚ôÄÔ∏è Exercise Trainer Assistant</h1>
    <p class="sub">Step 1 ‚Üí paste your training logs; Step 2 ‚Üí select body part & recent sessions; one-click compute <span class="muted">Volume = Weight √ó Reps √ó Sets</span>.</p>

    <!-- Page 1: data input -->
    <section id="page1" class="card">
      <div class="stack">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="pill">STEP 1 | Input Data</div>
        </div>
        <label class="muted">One record per line. The parser is tolerant, but the <strong>date must have "/" or "-" and be immediately followed by a comma</strong>, e.g.: <code>2025/09/18, Chest, ...</code></label>
        <textarea id="rawInput" placeholder="e.g. 2025/09/18, Chest, Flat Smith Press, Smith Machine, 90kg, 10 reps, 1 sets"></textarea>
        <div class="row" style="justify-content:flex-end">
          <button id="toPage2" class="btn btn-primary">Next ‚Üí Choose body part</button>
        </div>
        <div id="p1Error" class="err"></div>
      </div>
    </section>

    <div style="height:14px"></div>

    <!-- Page 2: options & result -->
    <section id="page2" class="card hidden">
      <div class="stack">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="pill">STEP 2 | Select body part & recent sessions</div>
          <div class="row">
            <button class="btn btn-secondary" id="backTo1">‚Üê Back</button>
            <button class="btn btn-primary" id="btnCompute">Compute Volume</button>
          </div>
        </div>

        <div class="grid cols-2">
          <div>
            <label for="bodyChoice" class="muted">Which body part to summarize? (type 1 or 2)</label>
            <div class="row">
              <select id="bodyChoice">
                <option value="1">1 = Chest</option>
                <option value="2">2 = Back</option>
              </select>
              <input id="recentCount" type="number" min="1" step="1" value="4" title="How many latest training days (dedup by date)?" />
            </div>
            <div class="note">We deduplicate by date and take the latest <span id="recentCountEcho">4</span> days for that body part.</div>
          </div>
          <div>
            <div class="note">Special rules are auto-applied:<br/>‚Ä¢ If <code>Equipment</code> contains <b>Dumbbell</b> or <b>Cable</b>, or the weight is written like <code>xxkg √ó 2</code>/<code>x2</code> ‚Üí treat as <b>bilateral</b> (Weight √ó 2).</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="box"><h4>Part</h4><div id="kpiPart">‚Äî</div></div>
          <div class="box"><h4>Days counted</h4><div id="kpiDays">‚Äî</div></div>
          <div class="box"><h4>Total Volume</h4><div id="kpiTotal">‚Äî</div></div>
        </div>

        <div id="resultArea" class="stack"></div>
        <div id="p2Error" class="err"></div>
        <div class="footer">Tip: click a date row to expand details.</div>
      </div>
    </section>
  </div>

  <script>
    // Ensure elements exist before binding listeners
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Utilities =====
      const $ = (s) => document.querySelector(s);
      const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
      const trim = (s) => (s||'').toString().trim();

      function notifyError(id, msg){
        const node = document.getElementById(id);
        if(!node) return;
        node.textContent = msg;
        node.classList.remove('shake');
        void node.offsetWidth; // reflow to replay animation
        node.classList.add('shake');
        node.scrollIntoView({behavior:'smooth', block:'nearest'});
      }

      function isValidDateToken(token){
        const t = String(token).trim();
        const sep = t.includes('/') ? '/' : (t.includes('-') ? '-' : null);
        if(!sep) return false;
        const arr = t.split(sep);
        if(arr.length!==3) return false;
        const y = parseInt(arr[0],10);
        const m = parseInt(arr[1],10);
        const d = parseInt(arr[2],10);
        if(!Number.isInteger(y) || !Number.isInteger(m) || !Number.isInteger(d)) return false;
        if(String(y).length!==4 || y<2000 || y>2099) return false;
        const dt = new Date(y, m-1, d);
        return dt && dt.getFullYear()===y && dt.getMonth()===m-1 && dt.getDate()===d;
      }

      // Find a date token that is followed by a comma (spaces allowed before the comma)
      function findDateWithComma(rawLine){
        const s = String(rawLine);
        const match = s.match(/(20\d{2}[\/-]\d{1,2}[\/-]\d{1,2})\s*,/);
        if(!match) return null;
        const token = match[1];
        if(!isValidDateToken(token)) return null;
        const parts = token.includes('/') ? token.split('/') : token.split('-');
        const y = parseInt(parts[0],10), m = parseInt(parts[1],10), d = parseInt(parts[2],10);
        const date = new Date(y, m-1, d);
        return { date, token };
      }

      function extractNumber(token){
        let s = '';
        const str = String(token);
        for(let i=0;i<str.length;i++){
          const ch = str[i];
          if((ch>='0' && ch<='9') || ch==='.') s += ch;
        }
        return s ? parseFloat(s) : NaN;
      }

      function hasDoubleSided(info){
        const equip = (info.equipment||'').toLowerCase();
        const dblByEquip = equip.includes('dumbbell') || equip.includes('cable');
        const wr = (info.weightRaw||'').toLowerCase();
        const dblByWeight = /x\s*2|√ó\s*2/.test(wr);
        return dblByEquip || dblByWeight;
      }

      function parseLine(line){
        const found = findDateWithComma(line);
        if(!found) return null;
        const date = found.date;

        const parts = line.split(',').map(s=>s.trim());
        const dateIdx = parts.findIndex(p => isValidDateToken(p));
        if(dateIdx===-1) return null;

        const body = parts[dateIdx+1] || '';
        const exercise = parts[dateIdx+2] || '';
        const equipment = parts[dateIdx+3] || '';
        const weightRaw = parts[dateIdx+4] || '';
        const repsRaw = parts[dateIdx+5] || '';
        const setsRaw = parts[dateIdx+6] || '';

        let weight = extractNumber(weightRaw);
        let reps = extractNumber(repsRaw);
        let sets = extractNumber(setsRaw);

        return { line, date, dateKey: date.toISOString().slice(0,10), body, exercise, equipment, weight, reps, sets, weightRaw, repsRaw, setsRaw };
      }

      function computeVolume(item){
        if(Number.isNaN(item.weight) || Number.isNaN(item.reps) || Number.isNaN(item.sets)) return 0;
        let w = item.weight;
        if(hasDoubleSided(item)) w = w * 2;
        return w * item.reps * item.sets;
      }

      // ===== State =====
      let parsed = [];

      // ===== Page 1 actions =====
      const btnNext = $('#toPage2');
      const rawInput = $('#rawInput');
      btnNext?.addEventListener('click',()=>{
        try{
          $('#p1Error').textContent = '';
          const txt = rawInput.value.trim();
          if(!txt){ notifyError('p1Error','Please paste your logs first.'); return; }
          const lines = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
          parsed = lines.map(parseLine).filter(Boolean);
          if(!parsed.length){ notifyError('p1Error','No valid lines parsed. Ensure the date uses "/" or "-" and is immediately followed by a comma.'); return; }
          $('#page1').classList.add('hidden');
          $('#page2').classList.remove('hidden');
        }catch(err){
          console.error(err);
          notifyError('p1Error','Unexpected error while parsing. Please check formatting.');
        }
      });

      // Echo recent count
      $('#recentCount').addEventListener('input', (e)=>{
        $('#recentCountEcho').textContent = e.target.value || '‚Äî';
      });

      // Back
      $('#backTo1').addEventListener('click', ()=>{
        $('#page2').classList.add('hidden');
        $('#page1').classList.remove('hidden');
        $('#p2Error').textContent = '';
        const status = document.getElementById('p2Status');
        if(status) status.textContent = '';
      });

      // ===== Core compute helpers =====
      function computeOnce(target, recentN){
        const rows = parsed.filter(r => (trim(r.body).toLowerCase()==='chest' || trim(r.body).toLowerCase()==='back') && trim(r.body).toLowerCase()===target.toLowerCase());
        if(!rows.length){
          return { ok:false, error:`No records for ${target}.` };
        }
        const byDate = {};
        for(const r of rows){
          if(!byDate[r.dateKey]) byDate[r.dateKey] = [];
          byDate[r.dateKey].push(r);
        }
        const dateKeys = Object.keys(byDate).sort((a,b)=> b.localeCompare(a));
        const pickedDates = dateKeys.slice(0, recentN);

        let total = 0;
        const perDate = [];
        for(const dk of pickedDates){
          let subtotal = 0;
          const details = [];
          for(const it of byDate[dk]){
            const v = computeVolume(it);
            if(v>0){
              subtotal += v;
              details.push({
                exercise: it.exercise || '‚Äî',
                equipment: it.equipment || '‚Äî',
                weight: it.weightRaw || String(it.weight||'‚Äî'),
                reps: it.reps||'‚Äî',
                sets: it.sets||'‚Äî',
                doubled: hasDoubleSided(it),
                vol: Math.round(v)
              });
            }
          }
          total += subtotal;
          perDate.push({ dk, subtotal: Math.round(subtotal), details });
        }
        const digest = JSON.stringify({ target, recentN:pickedDates.length, total: Math.round(total), perDate: perDate.map(d=>({dk:d.dk, subtotal:d.subtotal})) });
        return { ok:true, target, pickedDates, total: Math.round(total), perDate, digest };
      }

      function renderResult(bundle){
        $('#kpiPart').textContent = bundle.target;
        $('#kpiDays').textContent = bundle.pickedDates.length;
        $('#kpiTotal').textContent = Intl.NumberFormat('en-US').format(bundle.total);

        const resultArea = $('#resultArea');
        resultArea.innerHTML = '';
        bundle.perDate.forEach(group => {
          const sec = el('div','stack');
          const header = el('div','row');
          header.style.justifyContent = 'space-between';
          const hLeft = el('div');
          hLeft.innerHTML = `<strong>${group.dk}</strong> <span class="muted">(click to toggle)</span>`;
          const hRight = el('div');
          hRight.innerHTML = `<span class="pill">Day Volume: <b>${group.subtotal}</b></span>`;
          header.append(hLeft,hRight);

          const tableWrap = el('div');
          tableWrap.style.display = 'none';
          const tbl = el('table','table mono');
          tbl.innerHTML = `<thead><tr><th>Exercise</th><th>Equipment</th><th>Weight</th><th>Reps</th><th>Sets</th><th>Rule</th><th>Volume</th></tr></thead>`;
          const tb = el('tbody');
          group.details.forEach(d => {
            const tr = el('tr');
            tr.innerHTML = `
              <td>${d.exercise}</td>
              <td>${d.equipment}</td>
              <td>${d.weight}</td>
              <td>${d.reps}</td>
              <td>${d.sets}</td>
              <td>${d.doubled?'<span class="warn">√ó2 (bilateral)</span>':'‚Äî'}</td>
              <td>${d.vol}</td>
            `;
            tb.appendChild(tr);
          });
          tbl.appendChild(tb);
          tableWrap.appendChild(tbl);

          sec.append(header, tableWrap, el('div','hr'));
          header.addEventListener('click', ()=>{
            tableWrap.style.display = (tableWrap.style.display==='none')? 'block':'none';
          });
          resultArea.appendChild(sec);
        });
      }

      function setStatus(msg, cls){
        const status = document.getElementById('p2Status');
        if(!status) return;
        status.className = 'note ' + (cls||'');
        status.textContent = msg;
      }

      // Add a status row if not exists
      if(!document.getElementById('p2Status')){
        const st = document.createElement('div');
        st.id = 'p2Status';
        st.className = 'note';
        st.style.marginTop = '6px';
        document.querySelector('#page2 .stack').insertBefore(st, document.getElementById('resultArea'));
      }

      // ===== Verify by repeated computation (must match 3 times in a row) =====
      document.getElementById('btnCompute').addEventListener('click', ()=>{
        document.getElementById('p2Error').textContent = '';
        setStatus('Computing & verifying (need 3 consecutive identical results)‚Ä¶','');
        const choice = document.getElementById('bodyChoice').value;
        const target = choice==='1' ? 'Chest' : 'Back';
        const recentN = Math.max(1, parseInt(document.getElementById('recentCount').value||'4',10));

        let lastDigest = null;
        let stableCount = 0;
        let bestBundle = null;
        const MAX_ATTEMPTS = 50;

        for(let attempt=1; attempt<=MAX_ATTEMPTS; attempt++){
          const bundle = computeOnce(target, recentN);
          if(!bundle.ok){ document.getElementById('p2Error').textContent = bundle.error||'Insufficient data.'; setStatus('',''); return; }
          bestBundle = bundle;
          if(lastDigest===bundle.digest){
            stableCount++;
          } else {
            lastDigest = bundle.digest;
            stableCount = 1;
          }
          if(stableCount>=3){
            setStatus(`Verification passed: same result 3 times in a row (tries: ${attempt}).`,'ok');
            renderResult(bundle);
            return;
          }
        }
        setStatus('', '');
        document.getElementById('p2Error').textContent = 'Could not reach 3 consecutive identical results after multiple attempts. Check raw data formatting (date must be followed by a comma, numeric units, no swim-only rows), then try again.';
        if(bestBundle && bestBundle.ok){
          renderResult(bestBundle);
        }
      });
    });
  </script>
</body>
</html>
