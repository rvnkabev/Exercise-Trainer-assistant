```html
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ‹ï¸ Chest / Back è¨“ç·´ Volume åŠ©ç† â€” Instruction Module v4</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* å°å¼·åŒ–ï¼šè®“ç­‰å¯¬å­—é«”é¡¯ç¤ºè¨“ç·´ç´€éŒ„æ›´ç©©å®š */
    textarea, code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd { border: 1px solid #e5e7eb; border-bottom-width: 2px; border-radius: .375rem; padding: .125rem .375rem; background: #f8fafc; font-size: .75rem;}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-5xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="space-y-2">
      <h1 class="text-2xl sm:text-3xl font-bold">ğŸ‹ï¸ Chest / Back è¨“ç·´ Volume åŠ©ç†</h1>
      <p class="text-slate-600">ä¾ç…§ <span class="font-semibold">Instruction Module v4</span>ï¼šè§£æè‡ªç”±æ ¼å¼å¥èº«ç´€éŒ„ â†’ è‡ªå‹•ä¸‰æ¬¡é©—è­‰ï¼ˆ3/3ï¼‰â†’ è¼¸å‡ºæœ€è¿‘ 4 æ¬¡ç›®æ¨™éƒ¨ä½çš„ç¸½ Volumeã€‚</p>
    </header>

    <!-- Step Indicator -->
    <section class="grid sm:grid-cols-3 gap-3">
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 1</div>
        <div class="font-semibold">Behaviorï¼ˆè§’è‰²å®šä½ï¼‰</div>
        <div class="text-xs text-slate-500 mt-1">assistant = å°ˆæ¥­å¥èº«æ—¥èªŒåˆ†æåŠ©ç†</div>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 2</div>
        <div class="font-semibold">Workflow Logicï¼ˆæ“·å–/è¨ˆç®—ï¼‰</div>
        <div class="text-xs text-slate-500 mt-1">æ“·å–ç´€éŒ„ã€è­˜åˆ¥ Sessionã€è¨ˆç®— Volume</div>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 3 & 3.5</div>
        <div class="font-semibold">Validation & Loopï¼ˆä¸‰æ¬¡ç¢ºèªï¼‰</div>
        <div class="text-xs text-slate-500 mt-1">é€£çºŒ 3 æ¬¡é©—è­‰é€šéæ‰è¼¸å‡ºçµæœ</div>
      </div>
    </section>

    <!-- Controls -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <label class="text-sm font-semibold">é¸æ“‡éƒ¨ä½</label>
        <div class="flex gap-2">
          <button id="btnChest" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">1 = Chest</button>
          <button id="btnBack" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">2 = Back</button>
          <span id="targetBadge" class="hidden px-2 py-1 rounded-lg text-xs font-semibold bg-emerald-50 text-emerald-700">ç›®æ¨™ï¼š</span>
        </div>
      </div>

      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <label for="input" class="text-sm font-semibold">è²¼ä¸Šä½ çš„è‡ªç”±æ ¼å¼è¨“ç·´ç´€éŒ„</label>
          <button id="btnSample" class="text-xs underline text-slate-500 hover:text-slate-700">è¼‰å…¥ç¤ºä¾‹</button>
        </div>
        <textarea id="input" rows="10" class="w-full p-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="è²¼ä¸Šç´€éŒ„ï¼Œä¾‹å¦‚ï¼š
2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 10 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 9 reps, 3 sets
2025/7/21, Chest, Incline Smith Press, Smith Machine, 70kg, 12 reps, 4 sets
..."></textarea>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnRun" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[.99]">åŸ·è¡Œï¼ˆStep 2 â†’ 3 â†’ 3.5ï¼‰</button>
        <button id="btnClear" class="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">æ¸…ç©º</button>
        <span class="text-xs text-slate-500">æç¤ºï¼šç³»çµ±æœƒè‡ªå‹•é‡ç®—èˆ‡é©—è­‰ 3 æ¬¡ï¼Œä¸æœƒè©¢å•ä½¿ç”¨è€…ã€‚</span>
      </div>
    </section>

    <!-- Validation Console -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-3">
      <div class="flex items-center gap-2">
        <h2 class="text-lg font-semibold">é©—è­‰ Console</h2>
        <span class="text-xs text-slate-500">(Step 3 & 3.5)</span>
      </div>
      <div id="console" class="text-sm whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded-xl p-3 h-44 overflow-auto"></div>
    </section>

    <!-- Results -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-4">
      <div class="flex items-center gap-2">
        <h2 class="text-lg font-semibold">è¼¸å‡ºçµæœï¼ˆStep 4ï¼‰</h2>
        <span class="text-xs text-slate-500">æœ€è¿‘ 4 æ¬¡ç›®æ¨™éƒ¨ä½ Volume</span>
      </div>
      <div id="result" class="text-sm space-y-3"></div>
    </section>

    <!-- Footer / Help -->
    <footer class="text-xs text-slate-500 text-center py-6">
      Instruction Module v4ï¼ˆå«ä¸‰æ¬¡è‡ªå‹•é©—è­‰ 3/3ï¼‰ã€‚æŒ‰ <span class="kbd">1</span> / <span class="kbd">2</span> åˆ‡æ›éƒ¨ä½ï¼›æŒ‰ <span class="kbd">Enter</span> åŸ·è¡Œã€‚
    </footer>
  </main>

  <script>
    // ====== Instruction Module v4 constants ======
    const MATCH_CHEST = ["chest","middle chest","upper chest","smith machine chest","cable chest","fly","flyes","pec deck","incline smith","flat smith","smith"];
    const MATCH_BACK  = ["back","seat row","lat pulldown","machine row","cable row","reverse grip","row","pulldown","t-bar"];
    const EQUIP_KEYWORDS = ["dumbbell","cable","fly","smith","machine","pec deck","pulldown","row"]; // for é©—è­‰ä¸€
    const DATE_REGEX = /(?:\b|\D)(20\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})(?:\b|\D)/; // 2025/7/17 ç­‰
    const KG_REGEX = /(\d+(?:\.\d+)?)\s*kg/gi;
    const REPS_REGEX = /(\d+)\s*(?:reps?|æ¬¡)/i;
    const SETS_REGEX = /(\d+)\s*(?:sets?|çµ„)/i;
    const X2_REGEX = /(?:Ã—|x)\s*2\b/i;

    // ====== State ======
    let target = null; // "chest" | "back"
    const consoleEl = document.getElementById("console");
    const resultEl  = document.getElementById("result");
    const targetBadge = document.getElementById("targetBadge");
    const inputEl  = document.getElementById("input");

    // ====== UI helpers ======
    function log(msg){ consoleEl.textContent += msg + "\n"; consoleEl.scrollTop = consoleEl.scrollHeight; }
    function clearConsole(){ consoleEl.textContent = ""; }
    function showTarget(){
      if(!target){ targetBadge.classList.add("hidden"); targetBadge.textContent = ""; return; }
      targetBadge.classList.remove("hidden");
      targetBadge.textContent = "ç›®æ¨™ï¼š" + (target === "chest" ? "Chest" : "Back");
    }

    // ====== Parsing & Extraction ======
    function normalize(s){ return (s||"").toLowerCase(); }
    function hasAnyKeyword(line, keywords){
      const L = normalize(line);
      return keywords.some(k => L.includes(k));
    }
    function parseDate(line){
      const m = line.match(DATE_REGEX);
      if(!m) return null;
      const [_, y, mo, d] = m;
      const yyyy = parseInt(y,10);
      const mm = String(parseInt(mo,10)).padStart(2,"0");
      const dd = String(parseInt(d,10)).padStart(2,"0");
      // Return canonical "YYYY/MM/DD" and sortable key
      return { raw: `${yyyy}/${mm}/${dd}`, sortKey: `${yyyy}-${mm}-${dd}` };
    }
    function parseEntry(line, target){
      // Weight(s)
      // We support multiple "xxkg" per line; usually first is weight.
      const kgMatches = [...line.matchAll(KG_REGEX)];
      if(kgMatches.length===0) return null;
      let weight = parseFloat(kgMatches[0][1]);

      // reps
      const repsMatch = line.match(REPS_REGEX);
      let reps = repsMatch ? parseInt(repsMatch[1],10) : null;

      // sets
      const setsMatch = line.match(SETS_REGEX);
      let sets = setsMatch ? parseInt(setsMatch[1],10) : 3; // default sets=3

      // x2 rule
      const L = normalize(line);
      const haveX2 = X2_REGEX.test(line);
      const x2EquipHint = ["dumbbell","cable","fly","flyes","pec deck"].some(k => L.includes(k));
      if(haveX2 || x2EquipHint){ weight = weight * 2; }

      if(reps===null) return null;
      return { weight, reps, sets, volume: weight * reps * sets };
    }

    function targetKeywords(){
      return target === "chest" ? MATCH_CHEST : MATCH_BACK;
    }

    function extractSessions(raw){
      const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const groups = new Map(); // key: date+target -> { date, exercises: [], totalVolume }

      for(const line of lines){
        if(!hasAnyKeyword(line, targetKeywords())) continue;
        const date = parseDate(line);
        if(!date) continue;

        const key = date.sortKey + "|" + target;
        if(!groups.has(key)){
          groups.set(key, { date: date.raw, sortKey: date.sortKey, items: [], total: 0 });
        }
        const entry = parseEntry(line, target);
        if(entry){
          groups.get(key).items.push({ line, ...entry });
          groups.get(key).total += entry.volume;
        }
      }

      // sort sessions by date desc and keep last 4
      const sessions = [...groups.values()].sort((a,b)=> (a.sortKey < b.sortKey ? 1 : -1)).slice(0,4);
      return sessions;
    }

    // ====== Validations (Step 3) ======
    function validateOne_allEquipRecognized(sessions){
      // é©—è­‰ä¸€ï¼šå™¨æ¢°åç¨±å¯æ¨¡ç³Šæ¯”å°ï¼ˆè¡Œå…§å«ä»»ä¸€ EQUIP_KEYWORDS å³å¯ï¼‰
      for(const s of sessions){
        for(const it of s.items){
          if(!hasAnyKeyword(it.line, EQUIP_KEYWORDS)){
            return { ok:false, msg:`é©—è­‰ä¸€å¤±æ•—ï¼šæ‰¾ä¸åˆ°å¯è¾¨è­˜å™¨æ¢°é—œéµè© â†’ ã€Œ${it.line}ã€` };
          }
        }
      }
      return { ok:true, msg:"é©—è­‰ä¸€é€šéï¼šå™¨æ¢°é—œéµè©åŒ¹é…ï¼ˆæ¨¡ç³Šæ¯”å°ï¼‰" };
    }

    function validateTwo_perLineFormula(sessions){
      // é©—è­‰äºŒï¼šæ¯ç­†ç”¨ Weight Ã— Reps Ã— Sets è¨ˆç®—
      for(const s of sessions){
        for(const it of s.items){
          const expected = it.weight * it.reps * it.sets;
          if(Math.abs(expected - it.volume) > 1e-6){
            return { ok:false, msg:`é©—è­‰äºŒå¤±æ•—ï¼šé€ç­†è¨ˆç®—ä¸ä¸€è‡´ â†’ ã€Œ${it.line}ã€` };
          }
        }
      }
      return { ok:true, msg:"é©—è­‰äºŒé€šéï¼šé€ç­†è¨ˆç®—OKï¼ˆWÃ—RÃ—Sï¼‰" };
    }

    function validateThree_sessionSum(sessions){
      // é©—è­‰ä¸‰ï¼šåŒæ—¥åˆä½µã€ç¸½å’Œä¸€è‡´
      for(const s of sessions){
        const sum = s.items.reduce((acc, x)=> acc + x.volume, 0);
        if(Math.abs(sum - s.total) > 1e-6){
          return { ok:false, msg:`é©—è­‰ä¸‰å¤±æ•—ï¼šSession ç¸½é‡èˆ‡å„ç­†åŠ ç¸½ä¸ä¸€è‡´ â†’ ${s.date}` };
        }
      }
      return { ok:true, msg:"é©—è­‰ä¸‰é€šéï¼šåŒæ—¥åˆä½µç¸½é‡ä¸€è‡´" };
    }

    function runValidations(sessions){
      const v1 = validateOne_allEquipRecognized(sessions);
      log(v1.msg);
      if(!v1.ok) return false;

      const v2 = validateTwo_perLineFormula(sessions);
      log(v2.msg);
      if(!v2.ok) return false;

      const v3 = validateThree_sessionSum(sessions);
      log(v3.msg);
      if(!v3.ok) return false;

      log("é©—è­‰å››ï¼šéŒ¯èª¤é‡è·‘æ¢æ¬¾ â†’ï¼ˆä¸‰é …çš† OKï¼‰result = check OK");
      return true;
    }

    // ====== Step 3.5 Loop ï¼ˆä¸‰æ¬¡ç¢ºèªï¼‰ ======
    function triplePass(raw){
      let passCount = 0;
      const required = 3;

      for(let i=1;i<=6 && passCount<required;i++){ // å®‰å…¨ä¸Šé™ï¼šæœ€å¤šå˜—è©¦ 6 æ¬¡ï¼Œç¬¦åˆã€Œé‡ç®—ã€èªæ„
        log(`â€” è¿´åœˆå˜—è©¦ #${i}ï¼šå¾åŸå§‹ç´€éŒ„é‡æ–°æ“·å–èˆ‡è¨ˆç®—ï¼ˆä¸è©¢å•ä½¿ç”¨è€…ï¼‰`);
        const sessions = extractSessions(raw);

        if(sessions.length===0){
          log("âš ï¸ æœªæ“·å–åˆ°ä»»ä½•ç¬¦åˆç›®æ¨™éƒ¨ä½çš„ç´€éŒ„ï¼Œè¿´åœˆä¸­æ­¢ã€‚");
          return { ok:false, passCount, sessions: [] };
        }

        const ok = runValidations(sessions);
        if(ok){
          passCount += 1;
          log(`âœ… æœ¬è¼ªé©—è­‰çµæœï¼šcheck OKï¼ˆç´¯è¨ˆé€šé ${passCount}/${required}ï¼‰`);
        }else{
          passCount = 0;
          log("âŒ æœ¬è¼ªé©—è­‰å¤±æ•— â†’ ä¾è¦å‰‡å›åˆ° Step 2 é‡æ–°æ“·å– & é‡ç®—ï¼ˆpass_count æ­¸é›¶ï¼‰");
        }

        if(passCount < required){
          log("â†©ï¸ é€²è¡Œä¸‹ä¸€è¼ªé‡ç®—ï¼ˆGOTO Step 2ï¼‰");
        }
        if(passCount >= required){
          log("ğŸ‰ å·²é€£çºŒä¸‰æ¬¡é©—è­‰é€šéï¼ˆ3/3ï¼‰â†’ é€²å…¥ Step 4");
          const finalSessions = extractSessions(raw); // æŒ‰è¦æ ¼å†å¾åŸå§‹é‡æ“·å–
          return { ok:true, passCount, sessions: finalSessions };
        }
      }

      return { ok:false, passCount, sessions: [] };
    }

    // ====== Render Result (Step 4) ======
    function kgFmt(n){ return Math.round(n).toLocaleString(); }
    function renderResult(sessions){
      if(sessions.length===0){
        resultEl.innerHTML = `<div class="text-slate-500">å°šç„¡å¯è¼¸å‡ºçš„çµæœã€‚</div>`;
        return;
      }
      const title = target === "chest" ? "Chest" : "Back";
      let html = `<div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
        <div class="font-semibold">ğŸ“… æœ€è¿‘ 4 æ¬¡ ${title} è¨“ç·´ Volumeï¼š</div>
        <ol class="mt-2 space-y-3">`;

      for(const s of sessions){
        const items = s.items.map(it => {
          // å˜—è©¦æ“·å–å™¨æ¢°åç¨±çš„ç·šç´¢ï¼ˆå¾åŸè¡ŒæŠ“å¹¾å€‹é—œéµè©é¡¯ç¤ºï¼‰
          const equip = EQUIP_KEYWORDS.find(k => normalize(it.line).includes(k)) || "â€”";
          // é‡å»ºä¸€å€‹å¯è®€æ®µè½
          // ç›¡é‡å¾åŸè¡ŒæŠ“ç¬¬ä¸€å€‹ kg å€¼ï¼ˆå·²åœ¨ parse æ™‚è™•ç† x2ï¼‰
          const kgMatch = it.line.match(KG_REGEX);
          const rawKg = kgMatch ? kgMatch[0].toLowerCase() : (it.weight + "kg");
          const x2Shown = (it.weight % 1 === 0 && it.weight >= 2 && rawKg.includes("kg")) ? "" : "";
          return `- ${capitalize(equip)}ï¼š${kgFmt(it.weight)}kg Ã— ${it.reps} Ã— ${it.sets} = ${kgFmt(it.volume)} kg`;
        }).join("<br/>");

        html += `
          <li>
            <div class="font-medium">${s.date} â€” <span class="text-emerald-700 font-semibold">${kgFmt(s.total)} kg</span></div>
            <div class="text-slate-600 ml-2 mt-1">${items}</div>
          </li>`;
      }

      html += `</ol>
        <div class="mt-3 text-emerald-700 text-sm font-semibold">ğŸ”„ è‡ªå‹•ä¸‰æ¬¡é©—è­‰é€šéï¼š3/3ï¼ˆé‡ç®—æ ¡é©—å®Œæˆï¼›æœªç¶“ä½¿ç”¨è€…ç¢ºèªï¼‰</div>
      </div>`;

      resultEl.innerHTML = html;
    }

    function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    // ====== Wiring ======
    document.getElementById("btnChest").addEventListener("click", ()=>{ target = "chest"; showTarget(); });
    document.getElementById("btnBack").addEventListener("click",  ()=>{ target = "back";  showTarget();  });
    document.getElementById("btnClear").addEventListener("click", ()=>{
      inputEl.value = "";
      resultEl.innerHTML = "";
      clearConsole();
      target = null; showTarget();
    });

    document.getElementById("btnSample").addEventListener("click", ()=>{
      inputEl.value =
`2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 10 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 8 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 9 reps, 3 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 7 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 80kg, 9 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 80kg, 8 reps, 2 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 60kg, 20 reps, 1 sets
2025/7/21, Chest, Incline Smith Press, Smith Machine, 70kg, 12 reps, 4 sets
2025/7/30, Back, Lat Pulldown, 60kg, 10 reps, 3 sets
2025/7/30, Back, Machine Row, 40kg Ã— 2, 12 reps, 3 sets
2025/8/05, Chest, Dumbbell Press, 30kg Ã— 2, 10 reps, 3 sets
2025/8/05, Chest, Cable Fly, 25kg Ã— 2, 12 reps, 3 sets
2025/8/16, Back, Seat Row, 55kg, 10 reps, 3 sets
2025/8/28, Chest, Pec Deck Fly, 25kg Ã— 2, 12 reps, 3 sets`;
    });

    function ensureTargetOrHint(){
      if(!target){
        log("âš ï¸ å°šæœªé¸æ“‡éƒ¨ä½ã€‚è«‹é»æ“Šã€Œ1 = Chestã€æˆ–ã€Œ2 = Backã€ã€‚");
        return false;
      }
      return true;
    }

    function runAll(){
      clearConsole();
      resultEl.innerHTML = "";
      if(!ensureTargetOrHint()) return;

      log("Step 1ï¼šBehavior å•Ÿå‹• â†’ å°ˆæ¥­å¥èº«æ—¥èªŒåˆ†æåŠ©ç†");
      log("Step 2ï¼šæ“·å–ç´€éŒ„ã€è­˜åˆ¥ Sessionã€è¨ˆç®— Volumeï¼ˆå«è¦å‰‡ï¼šx2ã€é è¨­ sets=3ã€åŒæ—¥åˆä½µï¼‰");
      const raw = inputEl.value || "";

      const outcome = triplePass(raw);
      if(!outcome.ok){
        log(`â— æœªèƒ½é”åˆ° 3/3 é€šéï¼ˆç´¯è¨ˆé€šé ${outcome.passCount}/3ï¼‰ã€‚è«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼æˆ–é—œéµè©ã€‚`);
        renderResult([]); return;
      }
      renderResult(outcome.sessions);
    }

    document.getElementById("btnRun").addEventListener("click", runAll);
    // å¿«æ·éµï¼š1 / 2 é¸éƒ¨ä½ï¼ŒEnter åŸ·è¡Œ
    document.addEventListener("keydown", (e)=>{
      if(e.key==="1"){ target="chest"; showTarget(); }
      else if(e.key==="2"){ target="back"; showTarget(); }
      else if(e.key==="Enter"){ runAll(); }
    });
  </script>
</body>
</html>
```
