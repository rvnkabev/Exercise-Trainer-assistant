```html
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🏋️ Chest / Back 訓練 Volume 助理 — Instruction Module v4</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 小強化：讓等寬字體顯示訓練紀錄更穩定 */
    textarea, code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .kbd { border: 1px solid #e5e7eb; border-bottom-width: 2px; border-radius: .375rem; padding: .125rem .375rem; background: #f8fafc; font-size: .75rem;}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <main class="max-w-5xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="space-y-2">
      <h1 class="text-2xl sm:text-3xl font-bold">🏋️ Chest / Back 訓練 Volume 助理</h1>
      <p class="text-slate-600">依照 <span class="font-semibold">Instruction Module v4</span>：解析自由格式健身紀錄 → 自動三次驗證（3/3）→ 輸出最近 4 次目標部位的總 Volume。</p>
    </header>

    <!-- Step Indicator -->
    <section class="grid sm:grid-cols-3 gap-3">
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 1</div>
        <div class="font-semibold">Behavior（角色定位）</div>
        <div class="text-xs text-slate-500 mt-1">assistant = 專業健身日誌分析助理</div>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 2</div>
        <div class="font-semibold">Workflow Logic（擷取/計算）</div>
        <div class="text-xs text-slate-500 mt-1">擷取紀錄、識別 Session、計算 Volume</div>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow">
        <div class="text-sm text-slate-500">Step 3 & 3.5</div>
        <div class="font-semibold">Validation & Loop（三次確認）</div>
        <div class="text-xs text-slate-500 mt-1">連續 3 次驗證通過才輸出結果</div>
      </div>
    </section>

    <!-- Controls -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <label class="text-sm font-semibold">選擇部位</label>
        <div class="flex gap-2">
          <button id="btnChest" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">1 = Chest</button>
          <button id="btnBack" class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">2 = Back</button>
          <span id="targetBadge" class="hidden px-2 py-1 rounded-lg text-xs font-semibold bg-emerald-50 text-emerald-700">目標：</span>
        </div>
      </div>

      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <label for="input" class="text-sm font-semibold">貼上你的自由格式訓練紀錄</label>
          <button id="btnSample" class="text-xs underline text-slate-500 hover:text-slate-700">載入示例</button>
        </div>
        <textarea id="input" rows="10" class="w-full p-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="貼上紀錄，例如：
2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 10 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 9 reps, 3 sets
2025/7/21, Chest, Incline Smith Press, Smith Machine, 70kg, 12 reps, 4 sets
..."></textarea>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnRun" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[.99]">執行（Step 2 → 3 → 3.5）</button>
        <button id="btnClear" class="px-4 py-2 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.99]">清空</button>
        <span class="text-xs text-slate-500">提示：系統會自動重算與驗證 3 次，不會詢問使用者。</span>
      </div>
    </section>

    <!-- Validation Console -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-3">
      <div class="flex items-center gap-2">
        <h2 class="text-lg font-semibold">驗證 Console</h2>
        <span class="text-xs text-slate-500">(Step 3 & 3.5)</span>
      </div>
      <div id="console" class="text-sm whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded-xl p-3 h-44 overflow-auto"></div>
    </section>

    <!-- Results -->
    <section class="bg-white rounded-2xl shadow p-5 space-y-4">
      <div class="flex items-center gap-2">
        <h2 class="text-lg font-semibold">輸出結果（Step 4）</h2>
        <span class="text-xs text-slate-500">最近 4 次目標部位 Volume</span>
      </div>
      <div id="result" class="text-sm space-y-3"></div>
    </section>

    <!-- Footer / Help -->
    <footer class="text-xs text-slate-500 text-center py-6">
      Instruction Module v4（含三次自動驗證 3/3）。按 <span class="kbd">1</span> / <span class="kbd">2</span> 切換部位；按 <span class="kbd">Enter</span> 執行。
    </footer>
  </main>

  <script>
    // ====== Instruction Module v4 constants ======
    const MATCH_CHEST = ["chest","middle chest","upper chest","smith machine chest","cable chest","fly","flyes","pec deck","incline smith","flat smith","smith"];
    const MATCH_BACK  = ["back","seat row","lat pulldown","machine row","cable row","reverse grip","row","pulldown","t-bar"];
    const EQUIP_KEYWORDS = ["dumbbell","cable","fly","smith","machine","pec deck","pulldown","row"]; // for 驗證一
    const DATE_REGEX = /(?:\b|\D)(20\d{2})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})(?:\b|\D)/; // 2025/7/17 等
    const KG_REGEX = /(\d+(?:\.\d+)?)\s*kg/gi;
    const REPS_REGEX = /(\d+)\s*(?:reps?|次)/i;
    const SETS_REGEX = /(\d+)\s*(?:sets?|組)/i;
    const X2_REGEX = /(?:×|x)\s*2\b/i;

    // ====== State ======
    let target = null; // "chest" | "back"
    const consoleEl = document.getElementById("console");
    const resultEl  = document.getElementById("result");
    const targetBadge = document.getElementById("targetBadge");
    const inputEl  = document.getElementById("input");

    // ====== UI helpers ======
    function log(msg){ consoleEl.textContent += msg + "\n"; consoleEl.scrollTop = consoleEl.scrollHeight; }
    function clearConsole(){ consoleEl.textContent = ""; }
    function showTarget(){
      if(!target){ targetBadge.classList.add("hidden"); targetBadge.textContent = ""; return; }
      targetBadge.classList.remove("hidden");
      targetBadge.textContent = "目標：" + (target === "chest" ? "Chest" : "Back");
    }

    // ====== Parsing & Extraction ======
    function normalize(s){ return (s||"").toLowerCase(); }
    function hasAnyKeyword(line, keywords){
      const L = normalize(line);
      return keywords.some(k => L.includes(k));
    }
    function parseDate(line){
      const m = line.match(DATE_REGEX);
      if(!m) return null;
      const [_, y, mo, d] = m;
      const yyyy = parseInt(y,10);
      const mm = String(parseInt(mo,10)).padStart(2,"0");
      const dd = String(parseInt(d,10)).padStart(2,"0");
      // Return canonical "YYYY/MM/DD" and sortable key
      return { raw: `${yyyy}/${mm}/${dd}`, sortKey: `${yyyy}-${mm}-${dd}` };
    }
    function parseEntry(line, target){
      // Weight(s)
      // We support multiple "xxkg" per line; usually first is weight.
      const kgMatches = [...line.matchAll(KG_REGEX)];
      if(kgMatches.length===0) return null;
      let weight = parseFloat(kgMatches[0][1]);

      // reps
      const repsMatch = line.match(REPS_REGEX);
      let reps = repsMatch ? parseInt(repsMatch[1],10) : null;

      // sets
      const setsMatch = line.match(SETS_REGEX);
      let sets = setsMatch ? parseInt(setsMatch[1],10) : 3; // default sets=3

      // x2 rule
      const L = normalize(line);
      const haveX2 = X2_REGEX.test(line);
      const x2EquipHint = ["dumbbell","cable","fly","flyes","pec deck"].some(k => L.includes(k));
      if(haveX2 || x2EquipHint){ weight = weight * 2; }

      if(reps===null) return null;
      return { weight, reps, sets, volume: weight * reps * sets };
    }

    function targetKeywords(){
      return target === "chest" ? MATCH_CHEST : MATCH_BACK;
    }

    function extractSessions(raw){
      const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const groups = new Map(); // key: date+target -> { date, exercises: [], totalVolume }

      for(const line of lines){
        if(!hasAnyKeyword(line, targetKeywords())) continue;
        const date = parseDate(line);
        if(!date) continue;

        const key = date.sortKey + "|" + target;
        if(!groups.has(key)){
          groups.set(key, { date: date.raw, sortKey: date.sortKey, items: [], total: 0 });
        }
        const entry = parseEntry(line, target);
        if(entry){
          groups.get(key).items.push({ line, ...entry });
          groups.get(key).total += entry.volume;
        }
      }

      // sort sessions by date desc and keep last 4
      const sessions = [...groups.values()].sort((a,b)=> (a.sortKey < b.sortKey ? 1 : -1)).slice(0,4);
      return sessions;
    }

    // ====== Validations (Step 3) ======
    function validateOne_allEquipRecognized(sessions){
      // 驗證一：器械名稱可模糊比對（行內含任一 EQUIP_KEYWORDS 即可）
      for(const s of sessions){
        for(const it of s.items){
          if(!hasAnyKeyword(it.line, EQUIP_KEYWORDS)){
            return { ok:false, msg:`驗證一失敗：找不到可辨識器械關鍵詞 → 「${it.line}」` };
          }
        }
      }
      return { ok:true, msg:"驗證一通過：器械關鍵詞匹配（模糊比對）" };
    }

    function validateTwo_perLineFormula(sessions){
      // 驗證二：每筆用 Weight × Reps × Sets 計算
      for(const s of sessions){
        for(const it of s.items){
          const expected = it.weight * it.reps * it.sets;
          if(Math.abs(expected - it.volume) > 1e-6){
            return { ok:false, msg:`驗證二失敗：逐筆計算不一致 → 「${it.line}」` };
          }
        }
      }
      return { ok:true, msg:"驗證二通過：逐筆計算OK（W×R×S）" };
    }

    function validateThree_sessionSum(sessions){
      // 驗證三：同日合併、總和一致
      for(const s of sessions){
        const sum = s.items.reduce((acc, x)=> acc + x.volume, 0);
        if(Math.abs(sum - s.total) > 1e-6){
          return { ok:false, msg:`驗證三失敗：Session 總量與各筆加總不一致 → ${s.date}` };
        }
      }
      return { ok:true, msg:"驗證三通過：同日合併總量一致" };
    }

    function runValidations(sessions){
      const v1 = validateOne_allEquipRecognized(sessions);
      log(v1.msg);
      if(!v1.ok) return false;

      const v2 = validateTwo_perLineFormula(sessions);
      log(v2.msg);
      if(!v2.ok) return false;

      const v3 = validateThree_sessionSum(sessions);
      log(v3.msg);
      if(!v3.ok) return false;

      log("驗證四：錯誤重跑條款 →（三項皆 OK）result = check OK");
      return true;
    }

    // ====== Step 3.5 Loop （三次確認） ======
    function triplePass(raw){
      let passCount = 0;
      const required = 3;

      for(let i=1;i<=6 && passCount<required;i++){ // 安全上限：最多嘗試 6 次，符合「重算」語意
        log(`— 迴圈嘗試 #${i}：從原始紀錄重新擷取與計算（不詢問使用者）`);
        const sessions = extractSessions(raw);

        if(sessions.length===0){
          log("⚠️ 未擷取到任何符合目標部位的紀錄，迴圈中止。");
          return { ok:false, passCount, sessions: [] };
        }

        const ok = runValidations(sessions);
        if(ok){
          passCount += 1;
          log(`✅ 本輪驗證結果：check OK（累計通過 ${passCount}/${required}）`);
        }else{
          passCount = 0;
          log("❌ 本輪驗證失敗 → 依規則回到 Step 2 重新擷取 & 重算（pass_count 歸零）");
        }

        if(passCount < required){
          log("↩️ 進行下一輪重算（GOTO Step 2）");
        }
        if(passCount >= required){
          log("🎉 已連續三次驗證通過（3/3）→ 進入 Step 4");
          const finalSessions = extractSessions(raw); // 按規格再從原始重擷取
          return { ok:true, passCount, sessions: finalSessions };
        }
      }

      return { ok:false, passCount, sessions: [] };
    }

    // ====== Render Result (Step 4) ======
    function kgFmt(n){ return Math.round(n).toLocaleString(); }
    function renderResult(sessions){
      if(sessions.length===0){
        resultEl.innerHTML = `<div class="text-slate-500">尚無可輸出的結果。</div>`;
        return;
      }
      const title = target === "chest" ? "Chest" : "Back";
      let html = `<div class="rounded-xl border border-slate-200 p-4 bg-slate-50">
        <div class="font-semibold">📅 最近 4 次 ${title} 訓練 Volume：</div>
        <ol class="mt-2 space-y-3">`;

      for(const s of sessions){
        const items = s.items.map(it => {
          // 嘗試擷取器械名稱的線索（從原行抓幾個關鍵詞顯示）
          const equip = EQUIP_KEYWORDS.find(k => normalize(it.line).includes(k)) || "—";
          // 重建一個可讀段落
          // 盡量從原行抓第一個 kg 值（已在 parse 時處理 x2）
          const kgMatch = it.line.match(KG_REGEX);
          const rawKg = kgMatch ? kgMatch[0].toLowerCase() : (it.weight + "kg");
          const x2Shown = (it.weight % 1 === 0 && it.weight >= 2 && rawKg.includes("kg")) ? "" : "";
          return `- ${capitalize(equip)}：${kgFmt(it.weight)}kg × ${it.reps} × ${it.sets} = ${kgFmt(it.volume)} kg`;
        }).join("<br/>");

        html += `
          <li>
            <div class="font-medium">${s.date} — <span class="text-emerald-700 font-semibold">${kgFmt(s.total)} kg</span></div>
            <div class="text-slate-600 ml-2 mt-1">${items}</div>
          </li>`;
      }

      html += `</ol>
        <div class="mt-3 text-emerald-700 text-sm font-semibold">🔄 自動三次驗證通過：3/3（重算校驗完成；未經使用者確認）</div>
      </div>`;

      resultEl.innerHTML = html;
    }

    function capitalize(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    // ====== Wiring ======
    document.getElementById("btnChest").addEventListener("click", ()=>{ target = "chest"; showTarget(); });
    document.getElementById("btnBack").addEventListener("click",  ()=>{ target = "back";  showTarget();  });
    document.getElementById("btnClear").addEventListener("click", ()=>{
      inputEl.value = "";
      resultEl.innerHTML = "";
      clearConsole();
      target = null; showTarget();
    });

    document.getElementById("btnSample").addEventListener("click", ()=>{
      inputEl.value =
`2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 10 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 95kg, 8 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 9 reps, 3 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 90kg, 7 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 80kg, 9 reps, 1 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 80kg, 8 reps, 2 sets
2025/7/17, Chest, Flat Smith Press, Smith Machine, 60kg, 20 reps, 1 sets
2025/7/21, Chest, Incline Smith Press, Smith Machine, 70kg, 12 reps, 4 sets
2025/7/30, Back, Lat Pulldown, 60kg, 10 reps, 3 sets
2025/7/30, Back, Machine Row, 40kg × 2, 12 reps, 3 sets
2025/8/05, Chest, Dumbbell Press, 30kg × 2, 10 reps, 3 sets
2025/8/05, Chest, Cable Fly, 25kg × 2, 12 reps, 3 sets
2025/8/16, Back, Seat Row, 55kg, 10 reps, 3 sets
2025/8/28, Chest, Pec Deck Fly, 25kg × 2, 12 reps, 3 sets`;
    });

    function ensureTargetOrHint(){
      if(!target){
        log("⚠️ 尚未選擇部位。請點擊「1 = Chest」或「2 = Back」。");
        return false;
      }
      return true;
    }

    function runAll(){
      clearConsole();
      resultEl.innerHTML = "";
      if(!ensureTargetOrHint()) return;

      log("Step 1：Behavior 啟動 → 專業健身日誌分析助理");
      log("Step 2：擷取紀錄、識別 Session、計算 Volume（含規則：x2、預設 sets=3、同日合併）");
      const raw = inputEl.value || "";

      const outcome = triplePass(raw);
      if(!outcome.ok){
        log(`❗ 未能達到 3/3 通過（累計通過 ${outcome.passCount}/3）。請檢查輸入格式或關鍵詞。`);
        renderResult([]); return;
      }
      renderResult(outcome.sessions);
    }

    document.getElementById("btnRun").addEventListener("click", runAll);
    // 快捷鍵：1 / 2 選部位，Enter 執行
    document.addEventListener("keydown", (e)=>{
      if(e.key==="1"){ target="chest"; showTarget(); }
      else if(e.key==="2"){ target="back"; showTarget(); }
      else if(e.key==="Enter"){ runAll(); }
    });
  </script>
</body>
</html>
```
