<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exercise Trainer Assistant</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1024,#0a0f1e 40%,#0b1324);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1000px;margin:32px auto;padding:16px}
    .title{font-size:28px;font-weight:800;letter-spacing:.4px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 24px}
    .card{background:linear-gradient(180deg,#0d1427,#0b1020);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    textarea{width:100%;min-height:240px;background:#0b1222;color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:14px 16px;line-height:1.45;font-size:14px;resize:vertical}
    input,select{background:#0b1222;color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#06b6d4,#0ea5e9);color:#001018}
    .btn-secondary{background:#0b1222;border:1px solid #1f2937;color:var(--text)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .stack{display:grid;gap:14px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0b1222;border:1px solid #1f2937}
    .hr{height:1px;background:#1f2937;margin:12px 0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #1f2937;text-align:left}
    .table th{color:#a7b0c0;font-weight:700}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .box{flex:1 1 200px;border:1px solid #1f2937;border-radius:14px;padding:12px 14px;background:#0b1222}
    .kpi .box h4{margin:0 0 6px;font-size:12px;color:#b6c0cf;text-transform:uppercase;letter-spacing:.08em}
    .kpi .box div{font-size:22px;font-weight:800}
    .note{font-size:13px;color:#b3becf}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    .footer{margin-top:14px;font-size:12px;color:#8aa0b6}
    .hidden{display:none}
    code{background:#0b1222;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">ğŸ‹ï¸â€â™€ï¸ Exercise Trainer Assistant</h1>
    <p class="sub">Step 1 â†’ è²¼ä¸Šä½ çš„è¨“ç·´ç´€éŒ„ï¼›Step 2 â†’ é¸éƒ¨ä½èˆ‡å€é–“ï¼›ä¸€éµè¨ˆç®— <span class="muted">Volume = Weight Ã— Reps Ã— Sets</span>ã€‚</p>

    <!-- Page 1: data input -->
    <section id="page1" class="card">
      <div class="stack">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="pill">æ­¥é©Ÿ 1ï½œè¼¸å…¥è³‡æ–™</div>
          <button class="btn btn-secondary" id="btnFillSample">å¡«å…¥ç¤ºä¾‹</button>
        </div>
        <label class="muted">å°‡æ¯ä¸€ç­†ç´€éŒ„å„ä½”ä¸€è¡Œï¼Œæ ¼å¼å¯é¬†æ•£ï¼Œå·¥å…·æœƒè‡ªå‹•è§£æã€‚</label>
        <textarea id="rawInput" placeholder="e.g. 2025/9/18, Chest, Flat Smith Press, Smith Machine, 90kg, 10 reps, 1 sets"></textarea>
        <div class="row" style="justify-content:flex-end">
          <button id="toPage2" class="btn btn-primary">ä¸‹ä¸€æ­¥ â†’ é¸éƒ¨ä½èˆ‡æ¬¡æ•¸</button>
        </div>
        <div id="p1Error" class="err"></div>
      </div>
    </section>

    <div style="height:14px"></div>

    <!-- Page 2: options & result -->
    <section id="page2" class="card hidden">
      <div class="stack">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="pill">æ­¥é©Ÿ 2ï½œé¸éƒ¨ä½èˆ‡æœ€è¿‘æ¬¡æ•¸</div>
          <div class="row">
            <button class="btn btn-secondary" id="backTo1">â† è¿”å›</button>
            <button class="btn btn-primary" id="btnCompute">è¨ˆç®— Volume</button>
          </div>
        </div>

        <div class="grid cols-2">
          <div>
            <label for="bodyChoice" class="muted">ä½ æƒ³çµ±è¨ˆå“ªå€‹éƒ¨ä½çš„è¨“ç·´é‡ï¼Ÿï¼ˆè¼¸å…¥ 1 æˆ– 2ï¼‰</label>
            <div class="row">
              <select id="bodyChoice">
                <option value="1">1 = Chest</option>
                <option value="2">2 = Back</option>
              </select>
              <input id="recentCount" type="number" min="1" step="1" value="4" title="æœ€è¿‘å¹¾æ¬¡ï¼ˆä¾æ—¥æœŸå»é‡çš„è¨“ç·´æ—¥ï¼‰" />
            </div>
            <div class="note">æœƒä¾æ—¥æœŸå»é‡ï¼ŒæŠ“å–è©²éƒ¨ä½æœ€è¿‘ <span id="recentCountEcho">4</span> æ¬¡çš„ç¸½é‡é‡ã€‚</div>
          </div>
          <div>
            <div class="note">ç‰¹æ®Šæ¢ä»¶è‡ªå‹•å¥—ç”¨ï¼š<br/>â€¢ è‹¥ <code>Equipment</code> å« <b>Dumbbell</b> æˆ– <b>Cable</b>ï¼Œæˆ–é‡é‡å¯«æˆ <code>xxkg Ã— 2</code> â†’ ä»¥ <b>é›™é‚Š</b>è¨ˆç®—ï¼ˆé‡é‡Ã—2ï¼‰ã€‚</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpi">
          <div class="box"><h4>éƒ¨ä½</h4><div id="kpiPart">â€”</div></div>
          <div class="box"><h4>æœ€è¿‘æ¬¡æ•¸ï¼ˆå¤©ï¼‰</h4><div id="kpiDays">â€”</div></div>
          <div class="box"><h4>ç¸½ Volume</h4><div id="kpiTotal">â€”</div></div>
        </div>

        <div id="resultArea" class="stack"></div>
        <div id="p2Error" class="err"></div>
        <div class="footer">æç¤ºï¼šé»æ“Šä»»ä¸€æ—¥æœŸå¯å±•é–‹ç´°ç¯€ã€‚</div>
      </div>
    </section>
  </div>

  <script>
    // ===== Utilities =====
    const $ = (s) => document.querySelector(s);
    const el = (tag, cls) => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };
    const trim = (s) => (s||'').toString().trim();

    function parseDate(str){
      // Accept formats like 2025/9/18, 2025-09-18, 2025.9.18
      const t = str.replace(/\./g,'/').replace(/-/g,'/');
      const m = t.match(/(20\d{2})\/(\d{1,2})\/(\d{1,2})/);
      if(!m) return null;
      const [_, y, mo, d] = m.map(Number);
      const dt = new Date(y, mo-1, d);
      if(dt && dt.getFullYear()===y && dt.getMonth()===mo-1 && dt.getDate()===d) return dt;
      return null;
    }

    function normalizeNumber(token){
      // Extract integer from patterns like "90kg", "11 reps", "2 set", "9reps"
      const m = String(token).match(/(\d+(?:\.\d+)?)/);
      return m ? parseFloat(m[1]) : NaN;
    }

    function hasDoubleSided(info){
      // Equipment contains Dumbbell or Cable OR format like "24kg Ã— 2" or "24kgx2"
      const equip = (info.equipment||'').toLowerCase();
      const dblByEquip = /(dumbbell|cable)/i.test(equip);
      const dblByWeight = /x\s*2|Ã—\s*2/i.test(info.weightRaw||'');
      return dblByEquip || dblByWeight;
    }

    function parseLine(line){
      // Expected loose CSV-ish: date, bodyPart, exercise, equipment, weight, reps, sets
      // We allow missing commas and inconsistent spacing.
      const parts = line.split(/\s*,\s*/).map(s=>s.trim()).filter(Boolean);
      if(parts.length < 3) return null;
      // Find date token
      let dateIdx = -1;
      for(let i=0;i<parts.length;i++) if(parseDate(parts[i])) { dateIdx = i; break; }
      if(dateIdx===-1) return null;
      const date = parseDate(parts[dateIdx]);

      // Heuristics for fields
      const body = parts[dateIdx+1] || '';
      const exercise = parts[dateIdx+2] || '';
      const equipment = parts[dateIdx+3] || '';
      const weightRaw = parts[dateIdx+4] || '';
      const repsRaw = parts[dateIdx+5] || '';
      const setsRaw = parts[dateIdx+6] || '';

      // numeric
      let weight = normalizeNumber(weightRaw);
      let reps = normalizeNumber(repsRaw);
      let sets = normalizeNumber(setsRaw);

      // Some lines e.g. swimming may have distance instead of reps/sets; ignore for strength calc
      if(Number.isNaN(weight)){
        // still allow when weight explicitly "â€”" or missing; treat as NaN â†’ skip later
      }
      if(Number.isNaN(reps) && /(rep|æ¬¡)/i.test(repsRaw)) reps = normalizeNumber(repsRaw);
      if(Number.isNaN(sets) && /(set|çµ„)/i.test(setsRaw)) sets = normalizeNumber(setsRaw);

      return { line, date, dateKey: date.toISOString().slice(0,10), body, exercise, equipment, weight, reps, sets, weightRaw, repsRaw, setsRaw };
    }

    function computeVolume(item){
      if(Number.isNaN(item.weight) || Number.isNaN(item.reps) || Number.isNaN(item.sets)) return 0;
      let w = item.weight;
      if(hasDoubleSided(item)) w = w * 2;
      return w * item.reps * item.sets;
    }

    // ===== State =====
    let parsed = [];

    // ===== Page 1 actions =====
    const sample = `2025/9/15, Chest, Incline Dumbbell Press, Dumbbell, 28kg, 13 reps, 4 sets, 

2025/9/15, Chest, Incline Dumbbell Press, Dumbbell, 28kg, 8 reps, 1 sets,

2025/9/15, Chest, Incline Dumbbell Press, Dumbbell, 24kg, 13 reps, 2 sets, 

2025/9/15, Chest, Incline Dumbbell Press, Dumbbell, 24kg, 15 reps, 2 sets, 
2025/9/15, Chest, Chest Press, Machine, 70kg, 7 reps, 1 sets, 
2025/9/15, Swim, â€”, Pool, â€”, 30m, 5, 
2025/9/18, Chest, Flat Smith Press, Smith Machine, 90kg, 10 reps, 1 sets, 
2025/9/18, Chest, Flat Smith Press, Smith Machine, 90kg, 11 reps, 3 sets, 
2025/9/18, Chest, Flat Smith Press, Smith Machine, 90kg, 9reps, 1 sets, 
2025/9/18, Chest, Flat Smith Press, Smith Machine, 80kg, 11 reps, 1 sets, 
2025/9/18, Chest, Flat Smith Press, Smith Machine, 80kg, 9reps, 1 sets

2025/9/18, Chest, Flat Smith Press, Smith Machine, 80kg, 8reps, 1 sets
2025/9/18, Swim, â€”, Pool, â€”, 30m, 4, 
2025/9/21, Swim, â€”, Pool, â€”, 30m, 10 sets
2025/9/22, Chest, Chest Press, Machine, 70kg, 13reps, 1 sets
2025/9/22, Chest, Chest Press, Machine, 84kg, 11reps, 1 sets
2025/9/22, Chest, Chest Press, Machine, 84kg, 9reps, 1 sets
2025/9/22, Chest, Chest Press, Machine, 77kg, 10reps, 1 sets
2025/9/22, Chest, Chest Press, Machine, 77kg, 9reps, 2 set`;

    $('#btnFillSample').addEventListener('click',()=>{$('#rawInput').value = sample;});

    $('#toPage2').addEventListener('click',()=>{
      $('#p1Error').textContent = '';
      const txt = $('#rawInput').value.trim();
      if(!txt){ $('#p1Error').textContent = 'è«‹å…ˆè²¼ä¸Šè¨“ç·´ç´€éŒ„ã€‚'; return; }
      const lines = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      parsed = lines.map(parseLine).filter(Boolean);
      if(!parsed.length){ $('#p1Error').textContent = 'æ ¼å¼ç„¡æ³•è§£æï¼Œè«‹ç¢ºèªæ¯è¡Œå«æ—¥æœŸèˆ‡é …ç›®ã€‚'; return; }
      // Go next
      $('#page1').classList.add('hidden');
      $('#page2').classList.remove('hidden');
    });

    // Echo recent count
    $('#recentCount').addEventListener('input', (e)=>{
      $('#recentCountEcho').textContent = e.target.value || 'â€”';
    });

    // Back
    $('#backTo1').addEventListener('click', ()=>{
      $('#page2').classList.add('hidden');
      $('#page1').classList.remove('hidden');
      $('#p2Error').textContent = '';
    });

    // ===== Compute =====
    function computeOnce(target, recentN){
      // Filter by target body part; ignore lines where weight/reps/sets are NaN
      const rows = parsed.filter(r => /^(Chest|Back)$/i.test(trim(r.body)) && trim(r.body).toLowerCase()===target.toLowerCase());
      if(!rows.length){
        return { ok:false, error:`æ²’æœ‰æ‰¾åˆ° ${target} çš„ç´€éŒ„ã€‚` };
      }
      // Group by dateKey
      const byDate = {};
      for(const r of rows){
        if(!byDate[r.dateKey]) byDate[r.dateKey] = [];
        byDate[r.dateKey].push(r);
      }
      const dateKeys = Object.keys(byDate).sort((a,b)=> b.localeCompare(a)); // desc
      const pickedDates = dateKeys.slice(0, recentN);

      let total = 0;
      const perDate = [];
      for(const dk of pickedDates){
        let subtotal = 0;
        const details = [];
        for(const it of byDate[dk]){
          const v = computeVolume(it);
          if(v>0){
            subtotal += v;
            details.push({
              exercise: it.exercise || 'â€”',
              equipment: it.equipment || 'â€”',
              weight: it.weightRaw || String(it.weight||'â€”'),
              reps: it.reps||'â€”',
              sets: it.sets||'â€”',
              doubled: hasDoubleSided(it),
              vol: Math.round(v)
            });
          }
        }
        total += subtotal;
        perDate.push({ dk, subtotal: Math.round(subtotal), details });
      }
      const digest = JSON.stringify({
        target,
        recentN:pickedDates.length,
        total: Math.round(total),
        perDate: perDate.map(d=>({dk:d.dk, subtotal:d.subtotal}))
      });
      return { ok:true, target, pickedDates, total: Math.round(total), perDate, digest };
    }

    function renderResult(bundle){
      // Render KPIs
      $('#kpiPart').textContent = bundle.target;
      $('#kpiDays').textContent = bundle.pickedDates.length;
      $('#kpiTotal').textContent = Intl.NumberFormat('en-US').format(bundle.total);

      // Render result tables
      const resultArea = $('#resultArea');
      resultArea.innerHTML = '';
      bundle.perDate.forEach(group => {
        const sec = el('div','stack');
        const header = el('div','row');
        header.style.justifyContent = 'space-between';
        const hLeft = el('div');
        hLeft.innerHTML = `<strong>${group.dk}</strong> <span class="muted">ï¼ˆé»æ“Šå±•é–‹ / æ”¶åˆï¼‰</span>`;
        const hRight = el('div');
        hRight.innerHTML = `<span class="pill">ç•¶æ—¥ Volumeï¼š<b>${group.subtotal}</b></span>`;
        header.append(hLeft,hRight);

        const tableWrap = el('div');
        tableWrap.style.display = 'none';
        const tbl = el('table','table mono');
        tbl.innerHTML = `<thead><tr><th>Exercise</th><th>Equipment</th><th>Weight</th><th>Reps</th><th>Sets</th><th>Rule</th><th>Volume</th></tr></thead>`;
        const tb = el('tbody');
        group.details.forEach(d => {
          const tr = el('tr');
          tr.innerHTML = `
            <td>${d.exercise}</td>
            <td>${d.equipment}</td>
            <td>${d.weight}</td>
            <td>${d.reps}</td>
            <td>${d.sets}</td>
            <td>${d.doubled?'<span class="warn">Ã—2ï¼ˆé›™é‚Šï¼‰</span>':'â€”'}</td>
            <td>${d.vol}</td>
          `;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);
        tableWrap.appendChild(tbl);

        sec.append(header, tableWrap, el('div','hr'));
        header.addEventListener('click', ()=>{
          tableWrap.style.display = (tableWrap.style.display==='none')? 'block':'none';
        });
        resultArea.appendChild(sec);
      });
    }

    function setStatus(msg, cls){
      const status = document.getElementById('p2Status');
      if(!status) return;
      status.className = 'note ' + (cls||'');
      status.textContent = msg;
    }

    // Add a status row if not exists
    if(!document.getElementById('p2Status')){
      const st = document.createElement('div');
      st.id = 'p2Status';
      st.className = 'note';
      st.style.marginTop = '6px';
      $('#page2 .stack').insertBefore(st, document.getElementById('resultArea'));
    }

    $('#btnCompute').addEventListener('click', ()=>{
      $('#p2Error').textContent = '';
      setStatus('æ­£åœ¨è¨ˆç®—èˆ‡é©—è­‰ï¼ˆéœ€è¦é€£çºŒ 3 æ¬¡çµæœä¸€è‡´ï¼‰â€¦','');
      const choice = $('#bodyChoice').value;
      const target = choice==='1' ? 'Chest' : 'Back';
      const recentN = Math.max(1, parseInt($('#recentCount').value||'4',10));

      let lastDigest = null;
      let stableCount = 0;
      let bestBundle = null;
      const MAX_ATTEMPTS = 50;

      for(let attempt=1; attempt<=MAX_ATTEMPTS; attempt++){
        const bundle = computeOnce(target, recentN);
        if(!bundle.ok){ $('#p2Error').textContent = bundle.error||'è³‡æ–™ä¸è¶³'; setStatus('',''); return; }
        bestBundle = bundle; // keep the latest good one
        if(lastDigest===bundle.digest){
          stableCount++;
        } else {
          lastDigest = bundle.digest;
          stableCount = 1;
        }

        if(stableCount>=3){
          setStatus(`é©—è­‰é€šéï¼šçµæœå·²é€£çºŒ 3 æ¬¡ä¸€è‡´ï¼ˆå˜—è©¦ ${attempt} æ¬¡ï¼‰ã€‚`,'ok');
          renderResult(bundle);
          return;
        }
      }

      // If we reach here, could not stabilize
      setStatus('', '');
      $('#p2Error').textContent = 'å¤šæ¬¡é‡æ–°è¨ˆç®—ä»æœªé”åˆ°é€£çºŒ 3 æ¬¡ä¸€è‡´ã€‚è«‹æª¢æŸ¥åŸå§‹è³‡æ–™æ ¼å¼ï¼ˆä¾‹å¦‚ç¼ºå°‘é€—è™Ÿã€æ•¸å­—å–®ä½æˆ–æ··å…¥æ¸¸æ³³ç­‰éé‡é‡ç´€éŒ„ï¼‰ï¼Œå†è©¦ä¸€æ¬¡ã€‚';
      if(bestBundle && bestBundle.ok){
        // Show latest attempt anyway for reference
        renderResult(bestBundle);
      }
    });
  </script>
</body>
</html>
